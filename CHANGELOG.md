# 更新日志

## [1.0.7] - 2025-11-07

### 重要修复
- 🐛 **彻底解决停止警告问题**：不再出现"还有 X 个连接未能完全停止"的警告
- 🐛 **修复误报"恢复正常"问题**：停止时不再将 ping 统计信息误认为连接恢复
- ⚡ 主动停止机制：在 `stop_test` 中主动调用所有 SSH 客户端的 `stop_ping()`
- 🎯 避免重复操作：线程 `finally` 块不再重复调用 `stop_ping()`

### 技术改进
**问题分析：**
- 之前：等待线程自己检测 `self.running = False` 并退出（被动等待）
- 问题：线程可能仍在读取 ping 输出，导致无法在超时时间内完成清理

**优化方案：**
1. **主动停止**：在 `stop_test` 中统一对所有 SSH 客户端发送 Ctrl+C
2. **追踪客户端**：维护 `self.ssh_clients` 列表，便于批量操作
3. **避免重复**：线程的 `finally` 只负责关闭连接，不再调用 `stop_ping()`
4. **减少超时**：从8秒降到5秒（因为已主动停止，线程能更快响应）

### 停止流程
```
按 Ctrl+C
  ↓
stop_test() 主动对所有 SSH 发送 '\x03'  ← 新增！
  ↓
所有 execute_ping 立即停止主循环
  ↓
快速读取 ping 统计（0.3秒 + 10×0.05秒）
  ↓
关闭日志、关闭连接
  ↓
线程退出（1-2秒内全部完成） ✅
```

### 详细修复

**问题1：停止警告**
- 之前：被动等待线程自检 `self.running`，部分线程超时
- 现在：主动调用 `stop_ping()` 发送 Ctrl+C，线程快速响应
- 效果：不再有"X个连接未能完全停止"警告 ✅

**问题2：误报"恢复正常"**
- 之前：任何非丢包的行都触发"恢复正常"提示（包括统计信息）
- 问题：停止时会输出统计信息，被误判为连接恢复
- 现在：只有真正的 ping 响应（`bytes from`）才算恢复
- 效果：停止时不再误报"恢复正常" ✅

### 效果对比

**之前（v1.0.6）：**
```
^C
正在停止所有测试...
✓ 恢复正常: 10.201.96.36 -> 10.201.98.4: 共丢失 53 个包后恢复  ← 误报
✓ 恢复正常: 10.201.96.36 -> 10.201.98.4: 共丢失 53 个包后恢复  ← 误报
警告: 还有 13 个连接未能完全停止（但 ping 进程已终止）  ← 警告
```

**现在（v1.0.7）：**
```
^C
正在停止所有测试...
  已停止: 7/13 个连接...
所有测试已停止                    ← 干净利落 ✅
```

## [1.0.6] - 2025-11-06

### 性能优化
- ⚡ 优化停止机制：从串行等待改为并行等待
- ⚡ 停止时显示实时进度（已停止 X/Y 个连接）
- ⚡ 启动延迟从 0.1秒 减少到 0.05秒，加快启动速度
- 📊 添加停止超时警告（如有线程未能及时停止）

### 技术改进
**之前的问题：**
- 串行等待每个线程（13个线程 × 3秒 = 最多39秒）
- 实际上所有线程已同时停止，但程序在逐个等待

**现在的方案：**
- 并行等待所有线程（总超时固定5秒）
- 实时检查线程状态，全部停止即结束
- 显示停止进度，用户体验更好

### 停止时间对比
- 之前：理论最多 39秒（13×3），实际 2-5秒
- 现在：理论最多 5秒，实际 1-2秒 ⚡

## [1.0.5] - 2025-11-06

### 优化会话日志结构
- 📁 每次测试在 `results/sessions/` 下创建独立的时间戳目录
- 📝 会话日志文件名简化（移除时间戳，因为目录已包含）
- 🗂️ 更容易管理和归档每次测试的结果

### 目录结构变化
**之前：**
```
results/sessions/
├── 10_201_96_30_to_223_5_5_5_20251106_230756.log
├── 10_201_96_30_to_223_5_5_5_20251106_233806.log  ← 多次测试混在一起
└── ...
```

**现在：**
```
results/sessions/
├── 20251106_230756/           ← 第一次测试
│   ├── 10_201_96_30_to_223_5_5_5.log
│   └── ...
└── 20251106_233806/           ← 第二次测试
    ├── 10_201_96_30_to_223_5_5_5.log
    └── ...
```

### 优势
- 每次测试的文件完全独立，不会混淆
- 可以整个目录打包归档
- 删除旧测试记录更方便

## [1.0.4] - 2025-11-06

### 文档整理
- 📁 创建 `docs/` 目录，整理文档结构
- 📝 移动 `USAGE.md`、`PROJECT_STRUCTURE.md`、`STOP_MECHANISM.md` 到 `docs/`
- 🗑️ 删除过期的更新说明文档（UPDATE_v1.0.1.md, UPDATE_v1.0.2.md）
- 📚 在 README.md 中添加文档导航

### 项目根目录现在只保留
- `README.md` - 主文档
- `CHANGELOG.md` - 版本历史
- `main.py` - 主程序
- `requirements.txt` - 依赖列表

### 详细文档移至 docs/ 目录
- `docs/USAGE.md` - 使用指南
- `docs/PROJECT_STRUCTURE.md` - 架构说明
- `docs/STOP_MECHANISM.md` - 技术细节

## [1.0.3] - 2025-11-06

### 简化
- 🗑️ 移除 `create_excel_template.py` 模板生成脚本（不需要）
- 🗑️ 移除 `run.sh` 启动脚本（直接用 python3 命令更简单）
- 🗑️ 移除 `servers_template.xlsx`（只保留 `servers_empty.xlsx` 一个配置文件）
- 📝 更新文档，简化使用说明

### 理由
- 用户可以直接编辑 `servers_empty.xlsx`，不需要生成脚本
- 直接运行 `python3 main.py` 更直观，不需要封装脚本
- 简化项目结构，减少不必要的文件

## [1.0.2] - 2025-11-06

### 新增
- ✨ 为每个连接保存独立的会话日志文件
- ✨ 优化 ping 停止机制，模拟手动 Ctrl+C 操作
- ✨ 完整记录 ping 统计信息到会话日志

### 修复
- 🐛 修复 Ctrl+C 中断后的报错问题
- 🐛 修复停止速度慢的问题
- 🐛 修复报告中缺少原始回显

## [1.0.1] - 2025-11-06

### 修复
- 🐛 修复 Ctrl+C 中断后不生成测试报告的问题
- 🐛 修复持续丢包时控制台刷屏的问题

### 优化
- ✨ 实现智能丢包显示：首次丢包、每10个包、恢复时显示
- ✨ 改进异常处理流程，确保无论如何都会生成报告
- 📝 更新文档，说明智能显示机制

### 技术改进
- 在 `PingResult` 类中新增 `consecutive_losses` 字段
- 重构 `main.py` 的异常处理逻辑
- 优化输出回调函数的显示策略

## [1.0.0] - 2025-11-06

### 新增功能
- ✅ 批量 Ping 测试核心功能
- ✅ Excel 配置文件支持
- ✅ SSH 远程连接和命令执行
- ✅ 多线程并发测试
- ✅ 实时丢包检测和告警
- ✅ 详细测试报告生成
- ✅ 命令行参数支持
- ✅ 虚拟环境配置
- ✅ 一键启动脚本

### 技术特点
- 使用 paramiko 实现 SSH 连接
- 使用 pandas + openpyxl 处理 Excel 配置
- 多线程并发执行测试任务
- 线程安全的结果记录
- 优雅的异常处理和连接关闭
- 实时输出回调机制

### 文档
- README.md - 完整项目文档
- USAGE.md - 快速使用指南
- PROJECT_STRUCTURE.md - 架构说明
- CHANGELOG.md - 更新日志

### 配置文件
- servers_template.xlsx - 示例配置模板
- servers_empty.xlsx - 空白配置模板

### 工具脚本
- create_excel_template.py - 生成配置模板
- run.sh - 一键启动脚本

### 已知限制
- 配置文件使用明文密码（后续可支持 SSH 密钥）
- 最多支持每台服务器 4 个目标 IP（可扩展）
- 报告格式为纯文本（后续可支持 HTML/JSON）

## 后续计划

### v1.1.0
- [ ] 支持 SSH 密钥认证
- [ ] 配置文件密码加密
- [ ] 支持更多目标 IP（不限于4个）

### v1.2.0
- [ ] Web 界面实时监控
- [ ] HTML 格式报告
- [ ] 图表可视化

### v1.3.0
- [ ] 邮件/企业微信告警
- [ ] 自定义 ping 参数
- [ ] 支持其他测试命令（traceroute, mtr）

### v2.0.0
- [ ] 异步 I/O 重构（提升性能）
- [ ] 连接池机制
- [ ] 支持更大规模测试（1000+ 设备）

